<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katachi Generator - Test Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .test-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1200px;
        }
        
        .header-section {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 2rem;
            text-align: center;
        }
        
        .upload-slot {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .upload-slot:hover {
            border-color: #007bff;
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .upload-slot.has-image {
            border-color: #28a745;
            background-color: rgba(40, 167, 69, 0.05);
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .pattern-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pattern-card:hover {
            border-color: #007bff;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
        }
        
        .pattern-card.selected {
            border-color: #28a745;
            background-color: rgba(40, 167, 69, 0.1);
        }
        
        .generate-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            border-radius: 25px;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }
        
        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .progress-bar {
            height: 20px;
            border-radius: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            margin: 0.5rem;
        }
        
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="test-container">
            <!-- Header -->
            <div class="header-section">
                <h1><i class="fas fa-origami"></i> Katachi Generator Test Interface</h1>
                <p>Upload 5 JPG images, select an origami pattern, and generate your NFT HTML!</p>
                <small>Using the new modularized EJS template system</small>
            </div>
            
            <div class="container p-4">
                <!-- Image Upload Section -->
                <div class="row">
                    <div class="col-12">
                        <h3><i class="fas fa-images"></i> Step 1: Upload 5 JPG Images</h3>
                        <p class="text-muted">Select or drag & drop JPG images into each slot below</p>
                    </div>
                </div>
                
                <div class="row" id="imageSlots">
                    <!-- Image slots will be generated by JavaScript -->
                </div>
                
                <!-- Pattern Selection Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h3><i class="fas fa-shapes"></i> Step 2: Select Origami Pattern</h3>
                        <p class="text-muted">Choose from 5 beautiful origami patterns</p>
                    </div>
                </div>
                
                <div class="row" id="patternSelection">
                    <!-- Pattern cards will be generated by JavaScript -->
                </div>
                
                <!-- Configuration Section -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4><i class="fas fa-cogs"></i> Configuration</h4>
                        <div class="form-group">
                            <label for="walletAddress">Wallet Address</label>
                            <input type="text" class="form-control" id="walletAddress" 
                                   placeholder="0x..." value="test-wallet-address">
                        </div>
                        <div class="form-group">
                            <label for="seed">Random Seed (optional)</label>
                            <input type="text" class="form-control" id="seed" 
                                   placeholder="Leave empty for random">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h4><i class="fas fa-info-circle"></i> Status</h4>
                        <div id="statusDisplay">
                            <div class="status-badge status-info">Ready to upload images</div>
                        </div>
                        <div class="mt-3">
                            <div>Images: <span id="imageCount">0/5</span></div>
                            <div>Pattern: <span id="patternStatus">Not selected</span></div>
                            <div>Ready to generate: <span id="readyStatus" class="text-danger">No</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Generate Button -->
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <button class="generate-btn" id="generateBtn" disabled>
                            <i class="fas fa-magic"></i> Generate NFT HTML
                        </button>
                    </div>
                </div>
                
                <!-- Progress Section -->
                <div class="row mt-4" id="progressSection" style="display: none;">
                    <div class="col-12">
                        <h4><i class="fas fa-spinner fa-spin"></i> Generation Progress</h4>
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="progressText">Initializing...</div>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div class="row mt-4" id="resultSection" style="display: none;">
                    <div class="col-12">
                        <div class="result-section">
                            <h4><i class="fas fa-check-circle text-success"></i> Generation Complete!</h4>
                            <div id="resultContent">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let uploadedImages = {};
        let selectedPattern = null;
        
        // Origami patterns configuration
        const origamiPatterns = [
            { 
                type: 'airplane', 
                name: 'Paper Airplane', 
                description: 'Classic airplane design with clean fold lines',
                icon: '‚úàÔ∏è'
            },
            { 
                type: 'crane', 
                name: 'Traditional Crane', 
                description: 'Elegant Japanese crane with intricate folding',
                icon: 'üïäÔ∏è'
            },
            { 
                type: 'hypar', 
                name: 'Hyperbolic Paraboloid', 
                description: 'Mathematical geometric form with curved surfaces',
                icon: 'üìê'
            },
            { 
                type: 'pinwheel', 
                name: 'Pinwheel Base', 
                description: 'Radial pattern with spinning motion effect',
                icon: 'üåü'
            },
            { 
                type: 'flower', 
                name: 'Origami Flower', 
                description: 'Beautiful flower with petal-like formations',
                icon: 'üå∏'
            }
        ];
        
        $(document).ready(function() {
            initializeImageSlots();
            initializePatternSelection();
            updateStatus();
            
            // Auto-load test images
            loadTestImages();
        });
        
        function initializeImageSlots() {
            const slotsHtml = Array.from({length: 5}, (_, i) => `
                <div class="col-md-2 col-sm-4 mb-3">
                    <div class="upload-slot" onclick="triggerFileInput(${i + 1})">
                        <div id="slot-${i + 1}-content">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <div>Image ${i + 1}</div>
                            <small class="text-muted">Click to upload JPG</small>
                        </div>
                        <input type="file" id="file-${i + 1}" accept=".jpg,.jpeg" 
                               onchange="handleFileSelect(${i + 1}, this)" style="display: none;">
                    </div>
                </div>
            `).join('');
            
            $('#imageSlots').html(slotsHtml);
        }
        
        function initializePatternSelection() {
            const patternsHtml = origamiPatterns.map(pattern => `
                <div class="col-md-4 col-sm-6 mb-3">
                    <div class="pattern-card" onclick="selectPattern('${pattern.type}')">
                        <div class="text-center">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">${pattern.icon}</div>
                            <h5>${pattern.name}</h5>
                            <p class="text-muted small">${pattern.description}</p>
                            <div class="badge badge-secondary">Type: ${pattern.type}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            $('#patternSelection').html(patternsHtml);
        }
        
        function triggerFileInput(slotNumber) {
            $(`#file-${slotNumber}`).click();
        }
        
        function handleFileSelect(slotNumber, input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.match('image/jpeg')) {
                alert('Please select a JPG file');
                return;
            }
            
            // Read file as base64
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImages[slotNumber] = {
                    name: file.name,
                    data: e.target.result,
                    size: file.size
                };
                
                updateImageSlot(slotNumber, e.target.result, file.name);
                updateStatus();
            };
            reader.readAsDataURL(file);
        }
        
        function updateImageSlot(slotNumber, dataUrl, filename) {
            const slotContent = `
                <div>
                    <img src="${dataUrl}" alt="${filename}" class="image-preview mb-2">
                    <div class="small text-success">${filename}</div>
                    <button class="btn btn-sm btn-outline-danger mt-1" 
                            onclick="removeImage(${slotNumber})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            $(`#slot-${slotNumber}-content`).html(slotContent);
            $(`.upload-slot`).eq(slotNumber - 1).addClass('has-image');
        }
        
        function removeImage(slotNumber) {
            delete uploadedImages[slotNumber];
            
            const defaultContent = `
                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                <div>Image ${slotNumber}</div>
                <small class="text-muted">Click to upload JPG</small>
            `;
            
            $(`#slot-${slotNumber}-content`).html(defaultContent);
            $(`.upload-slot`).eq(slotNumber - 1).removeClass('has-image');
            $(`#file-${slotNumber}`).val('');
            
            updateStatus();
        }
        
        function selectPattern(patternType) {
            selectedPattern = patternType;
            
            // Update visual selection
            $('.pattern-card').removeClass('selected');
            event.currentTarget.classList.add('selected');
            
            updateStatus();
        }
        
        function updateStatus() {
            const imageCount = Object.keys(uploadedImages).length;
            const isReady = imageCount === 5 && selectedPattern;
            
            $('#imageCount').text(`${imageCount}/5`);
            $('#patternStatus').text(selectedPattern ? 
                origamiPatterns.find(p => p.type === selectedPattern).name : 
                'Not selected');
            $('#readyStatus').text(isReady ? 'Yes' : 'No')
                           .removeClass('text-danger text-success')
                           .addClass(isReady ? 'text-success' : 'text-danger');
            
            $('#generateBtn').prop('disabled', !isReady);
            
            // Update status badges
            let statusHtml = '';
            if (imageCount === 0) {
                statusHtml = '<div class="status-badge status-info">Ready to upload images</div>';
            } else if (imageCount < 5) {
                statusHtml = '<div class="status-badge status-warning">Need more images</div>';
            } else if (!selectedPattern) {
                statusHtml = '<div class="status-badge status-warning">Select a pattern</div>';
            } else {
                statusHtml = '<div class="status-badge status-success">Ready to generate!</div>';
            }
            $('#statusDisplay').html(statusHtml);
        }
        
        async function loadTestImages() {
            const testImages = [
                'ocote-tekno.gif',
                'thankyoux-theprocess.png', 
                'thankyouX.gif',
                'xcopy-copesalada.gif',
                'yatreda-1.png'
            ];
            
            console.log('Loading test images automatically...');
            
            for (let i = 0; i < testImages.length; i++) {
                const imagePath = `/assets/test-imgs/${testImages[i]}`;
                
                try {
                    // Fetch the image and convert to base64
                    const response = await fetch(imagePath);
                    const blob = await response.blob();
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages[i + 1] = {
                            name: testImages[i],
                            data: e.target.result,
                            size: blob.size
                        };
                        
                        updateImageSlot(i + 1, e.target.result, testImages[i]);
                        updateStatus();
                        
                        console.log(`Loaded test image ${i + 1}: ${testImages[i]}`);
                    };
                    reader.readAsDataURL(blob);
                } catch (error) {
                    console.error(`Failed to load test image ${testImages[i]}:`, error);
                }
            }
        }
        
        $('#generateBtn').click(function() {
            if (!selectedPattern || Object.keys(uploadedImages).length !== 5) {
                alert('Please upload 5 images and select a pattern first');
                return;
            }
            
            generateNFT();
        });
        
        async function generateNFT() {
            // Show progress section
            $('#progressSection').show();
            $('#generateBtn').prop('disabled', true);
            
            try {
                // Prepare the request data
                const requestData = {
                    walletAddress: $('#walletAddress').val() || 'test-wallet-address',
                    patternType: selectedPattern,
                    seed2: $('#seed').val() || '',
                    forMinting: false, // Testing mode
                    testInterface: true, // Flag to indicate this is from test.html
                    source: 'test', // Alternative flag
                    images: Object.values(uploadedImages).map((img, index) => ({
                        data: img.data,
                        name: img.name || `image-${index + 1}.jpg`
                    }))
                };
                
                updateProgress(20, 'Sending request to server...');
                
                // Send request to the pattern generation endpoint
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                updateProgress(50, 'Processing images...');
                
                const result = await response.json();
                
                updateProgress(80, 'Generating HTML template...');
                
                if (result.success) {
                    updateProgress(100, 'Generation complete!');
                    displayResults(result);
                } else {
                    throw new Error(result.error || 'Generation failed');
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                displayError(error.message);
            } finally {
                $('#generateBtn').prop('disabled', false);
            }
        }
        
        function updateProgress(percentage, text) {
            $('#progressBar').css('width', `${percentage}%`);
            $('#progressText').text(text);
        }
        
        function displayResults(result) {
            $('#progressSection').hide();
            $('#resultSection').show();
            
            // Get the local URL for the generated HTML
            const localUrl = result.previewHtmlUrl || result.htmlUrl;
            
            const resultHtml = `
                <div class="alert alert-success mb-4">
                    <h4><i class="fas fa-check-circle"></i> EJS Template Compiled Successfully!</h4>
                    <div class="mt-3 p-3" style="background: #f0f0f0; border-radius: 5px;">
                        <strong>üîó Local HTML File:</strong><br>
                        <a href="${localUrl}" target="_blank" style="font-family: monospace; word-break: break-all; font-size: 1.1em;">
                            ${localUrl}
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-file-code"></i> Generated Files</h5>
                        ${localUrl ? `
                            <div class="mb-2">
                                <a href="${localUrl}" target="_blank" class="btn btn-primary btn-lg btn-block">
                                    <i class="fas fa-external-link-alt"></i> Open HTML in New Tab
                                </a>
                            </div>
                        ` : ''}
                        ${result.thumbnailUrl ? `
                            <div class="mb-2">
                                <strong>Thumbnail:</strong>
                                <br><a href="${result.thumbnailUrl}" target="_blank" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-image"></i> View Thumbnail
                                </a>
                            </div>
                        ` : ''}
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-info-circle"></i> Generation Details</h5>
                        <div class="small">
                            <div><strong>Pattern:</strong> ${selectedPattern}</div>
                            <div><strong>Images:</strong> ${Object.keys(uploadedImages).length}</div>
                            <div><strong>Wallet:</strong> ${$('#walletAddress').val()}</div>
                            ${result.processingTime ? `<div><strong>Time:</strong> ${result.processingTime}ms</div>` : ''}
                            <div><strong>Template Version:</strong> ${result.templateVersion || 'EJS Modular'}</div>
                        </div>
                    </div>
                </div>
                ${result.thumbnailUrl ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h5>Preview</h5>
                            <img src="${result.thumbnailUrl}" alt="Generated NFT Preview" 
                                 class="img-fluid border rounded" style="max-height: 300px;">
                        </div>
                    </div>
                ` : ''}
            `;
            
            $('#resultContent').html(resultHtml);
        }
        
        function displayError(errorMessage) {
            $('#progressSection').hide();
            $('#resultSection').show();
            
            const errorHtml = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> Generation Failed</h5>
                    <p>${errorMessage}</p>
                    <hr>
                    <small>Check the browser console for more details.</small>
                </div>
            `;
            
            $('#resultContent').html(errorHtml);
        }
    </script>
</body>
</html>